# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ ClickHouse
–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ—à–∞–≥–æ–≤–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –í–∞—à–µ–≥–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ ClickHouse

# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
![clickhouse](https://github.com/user-attachments/assets/8d9c3a9c-0ba3-4f3f-afa5-c58df470bb59)

| –†–æ–ª—å				| –≠—Ç–æ –∫—Ç–æ  			|–û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞				| –ü–æ—Ä—Ç—ã				|
|-------------------|-------------------|-------------------------------|-------------------|
|ClickHouse Server	|–õ—é–±–∞—è –Ω–æ–¥–∞			|SQL, —Ö—Ä–∞–Ω–µ–Ω–∏–µ, distributed		|9000 / 8123 / 9009	|
|Coordinator		|–õ—é–±–∞—è –Ω–æ–¥–∞			|–ü–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–∞					| ‚Äî					|
|Shard				|–õ–æ–≥–∏—á–µ—Å–∫–∞—è —Å—É—â–Ω–æ—Å—Ç—å|–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ	| ‚Äî					|
|Replica			|–ù–æ–¥–∞				|–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å				| ‚Äî					|
|ZooKeeper			|–û—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å	|–ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ		|2181 / 2888 / 3888	|
|Client				|–í–Ω–µ—à–Ω–∏–π			|–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤				|9000 / 8123		|

# –°—Å—ã–ª–∫–∏
1. –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è\
Install ClickHouse on Debian/Ubuntu\
https://clickhouse.com/docs/install?ysclid=mkzsgud2sc374410174

2. Github\
Install_ClickHouse_Cluster\
https://gist.github.com/thanhthai3010/22f8d3d1f0d0897255b84f37571b683d

3. –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è\
–î–≤–∏–∂–∫–∏ —Ç–∞–±–ª–∏—Ü\
https://clickhouse.com/docs/ru/engines/table-engines?ysclid=mldumst6yy94100096

4. ChatGPT



# –†–æ–ª–∏ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

–í ClickHouse –≤–∞–∂–Ω–æ —Å—Ä–∞–∑—É –≤—ã–∫–∏–Ω—É—Ç—å ¬´hadoop-–º—ã—à–ª–µ–Ω–∏–µ¬ª: —Ñ–æ—Ä–º–∞–ª—å–Ω—ã—Ö master / worker —Ä–æ–ª–µ–π –ø–æ—á—Ç–∏ –Ω–µ—Ç. –ü–æ—á—Ç–∏ –∫–∞–∂–¥–∞—è –Ω–æ–¥–∞ ‚Äî –∏ —Å–µ—Ä–≤–µ—Ä, –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä.\
ClickHouse Server (—á–∞—Å—Ç–æ –Ω–∞–∑—ã–≤–∞—é—Ç ¬´master-–Ω–æ–¥–∞¬ª) - –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –≤—Å–µ ClickHouse-–Ω–æ–¥—ã —Ä–∞–≤–Ω–æ–ø—Ä–∞–≤–Ω—ã.

----------------------------------------------
1. ClickHouse Server ‚Äî —ç—Ç–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —É–∑–µ–ª, –∫–æ—Ç–æ—Ä—ã–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å:
	* –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–æ–º –∑–∞–ø—Ä–æ—Å–∞
	* —Ö—Ä–∞–Ω–∏—Ç–µ–ª–µ–º –¥–∞–Ω–Ω—ã—Ö
	* —Ä–µ–ø–ª–∏–∫–æ–π
	* —É—á–∞—Å—Ç–Ω–∏–∫–æ–º DDL ON CLUSTER
	* —É—á–∞—Å—Ç–Ω–∏–∫–æ–º distributed insert/select


–ù–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ master-–∞, –ª—é–±–∞—è –Ω–æ–¥–∞ –º–æ–∂–µ—Ç:\
	* –ø—Ä–∏–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞\
	* —Ä–∞–∑–æ—Å–ª–∞—Ç—å –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã –ø–æ –∫–ª–∞—Å—Ç–µ—Ä—É\
	* –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç


–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:\
	* –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (MergeTree, ReplicatedMergeTree)\
	* –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL\
	* –ú–µ–∂–Ω–æ–¥–æ–≤–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ\
	* –†–µ–ø–ª–∏–∫–∞—Ü–∏—è (—á–µ—Ä–µ–∑ ZooKeeper)\
	* Distributed tables\
	* DDL ON CLUSTER

–ü–æ—Ä—Ç—ã ClickHouse Server

| –ü–æ—Ä—Ç	| –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ													|–ü—Ä–æ—Ç–æ–∫–æ–ª	|
|-------|---------------------------------------------------------------|-----------|
|9000	|Native client / server / distributed - –æ—Å–Ω–æ–≤–Ω–æ–π ¬´—Ä–∞–±–æ—á–∏–π¬ª –ø–æ—Ä—Ç	|TCP		|
|8123	|HTTP API - —á–∞—Å—Ç–æ –Ω—É–∂–µ–Ω BI / curl / REST						|HTTP		|
|9009	|Interserver (–∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏)							|HTTP		|
|9440	|HTTPS (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω)											|HTTPS		|


–†–æ–ª—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –∏ –∑–∞–ø—Ä–æ—Å–æ–º, –∞ –Ω–µ —Ç–∏–ø–æ–º –Ω–æ–¥—ã, –ø—Ä–∏–º–µ—Ä:\
	* —Ç—ã –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ ch-master-1\
	* —Å–¥–µ–ª–∞–ª SELECT FROM events_dist\
	* ch-master-1 —Å—Ç–∞–ª –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–æ–º\
	* –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º–∏

----------------------------------------------
2. Client (clickhouse-client, BI, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ) - —ç—Ç–æ –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤, –∞ –Ω–µ —á–∞—Å—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–∞.
–ú–æ–∂–µ—Ç –±—ã—Ç—å:
	* clickhouse-client
	* BI (Superset, Metabase, PowerBI)
	* backend-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
	* ETL job

–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:\
	* –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –ª—é–±–æ–π ClickHouse-–Ω–æ–¥–µ\
	* –ù–µ –∑–Ω–∞–µ—Ç –æ —à–∞—Ä–¥–∞—Ö\
	* –ù–µ –∑–Ω–∞–µ—Ç –æ —Ä–µ–ø–ª–∏–∫–∞—Ö\
	* –í—Å—è –ª–æ–≥–∏–∫–∞ ‚Äî –≤–Ω—É—Ç—Ä–∏ ClickHouse

–ö–ª–∏–µ–Ω—Ç –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –æ–±—â–∞–µ—Ç—Å—è —Å ZooKeeper\
–ü–æ—Ä—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞:

|–ü–æ—Ä—Ç|–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è|
|----|------------------|
|9000|clickhouse-client |
|8123|HTTP / BI			|
|9440|HTTPS				|

----------------------------------------------

2.3. ZooKeeper (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä, –∞ –Ω–µ data node) - –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ –Ω–µ—Ç –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥—ã, –∫–∞–∫ –≤ GreenPlum / Hadoop, –≤—Å—é –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—é –≤—ã–ø–æ–ª–Ω—è–µ—Ç ZooKeeper.\
ZooKeeper ‚Äî —ç—Ç–æ control plane ClickHouse, –∞ –Ω–µ data plane.

–û–Ω –ù–ï:\
	* —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü\
	* —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö\
	* —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –∞–≥—Ä–µ–≥–∞—Ü–∏—è—Ö

–û–Ω:\
	* —Ö—Ä–∞–Ω–∏—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ä–µ–ø–ª–∏–∫\
	* –≤—ã–±–∏—Ä–∞–µ—Ç –ª–∏–¥–µ—Ä–∞ —Ä–µ–ø–ª–∏–∫–∏\
	* —Ö—Ä–∞–Ω–∏—Ç –æ—á–µ—Ä–µ–¥—å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏\
	* –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç DDL ON CLUSTER

–ß—Ç–æ –∏–º–µ–Ω–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ ZooKeeper:\
	* /clickhouse/tables/{shard}/{table}\
	* –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–ø–ª–∏–∫–∞—Ö\
	* log —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏\
	* distributed DDL queue

–ë–µ–∑ ZooKeeper:\
	* —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç\
	* ON CLUSTER –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ü–æ—Ä—Ç—ã ZooKeeper
|–ü–æ—Ä—Ç|–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ			|
|----|----------------------|
|2181|–ö–ª–∏–µ–Ω—Ç—ã (ClickHouse)	|
|2888|Leader ‚Üî Follower		|
|3888|Leader election		|

–ì–¥–µ –æ–Ω —Å—Ç–∞–≤–∏—Ç—Å—è:\
	* –æ–±—ã—á–Ω–æ –Ω–µ—á–µ—Ç–Ω–æ–µ –∫–æ–ª-–≤–æ –Ω–æ–¥: 3 –∏–ª–∏ 5 –Ω–æ–¥\
	* –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–≤–º–µ—â—ë–Ω —Å ClickHouse (–Ω–æ —ç—Ç–æ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç!)\
	* –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–º –∫–ª–∞—Å—Ç–µ—Ä–æ–º

----------------------------------------------

4. –õ–æ–≥–∏—á–µ—Å–∫–∏–µ —Ä–æ–ª–∏ –≤–Ω—É—Ç—Ä–∏ ClickHouse.
–≠—Ç–æ –Ω–µ –Ω–æ–¥—ã, –∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏:
	* –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞ - –Ω–æ–¥–∞, –∫—É–¥–∞ –ø—Ä–∏—à—ë–ª –∑–∞–ø—Ä–æ—Å: –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ú–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±–æ–π –Ω–æ–¥–æ–π!
	* –®–∞—Ä–¥ - –ª–æ–≥–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –≤ remote_servers.xml, –æ–¥–∏–Ω —à–∞—Ä–¥ = –Ω–∞–±–æ—Ä —Ä–µ–ø–ª–∏–∫
	* –†–µ–ø–ª–∏–∫–∞ - –∫–æ–ø–∏—è –¥–∞–Ω–Ω—ã—Ö —à–∞—Ä–¥–∞, —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ ZooKeeper, –æ–¥–Ω–∞ –∏–∑ —Ä–µ–ø–ª–∏–∫ ‚Äî leader
	* Leader —Ä–µ–ø–ª–∏–∫–∏ - –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è ZooKeeper, –ø—Ä–∏–Ω–∏–º–∞–µ—Ç INSERT, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç –¥–∞–Ω–Ω—ã–µ

----------------------------------------------

5. –ö–∞–∫ —ç—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–º–µ—Å—Ç–µ.

INSERT –≤ Distributed\
	* –ö–ª–∏–µ–Ω—Ç ‚Üí –ª—é–±–∞—è CH-–Ω–æ–¥–∞\
	* –≠—Ç–∞ –Ω–æ–¥–∞ = –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä\
	* –í—ã–±–∏—Ä–∞–µ—Ç—Å—è —à–∞—Ä–¥\
	* INSERT –∏–¥—ë—Ç –≤ –æ–¥–Ω—É —Ä–µ–ø–ª–∏–∫—É\
	* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–ø–ª–∏–∫–∏ –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ ZooKeeper


SELECT –∏–∑ Distributed\
	* –ö–ª–∏–µ–Ω—Ç ‚Üí –ª—é–±–∞—è CH-–Ω–æ–¥–∞\
	* –ü–æ–¥–∑–∞–ø—Ä–æ—Å—ã ‚Üí –≤—Å–µ —à–∞—Ä–¥—ã\
	* –†–µ–ø–ª–∏–∫–∞ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\
	* –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä —Å–æ–±–∏—Ä–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç

# –î–≤–∏–∂–∫–∏

ClickHouse-–¥–≤–∏–∂–∫–∏ ‚Äî —ç—Ç–æ —Å–µ—Ä–¥—Ü–µ —Ñ–∏–ª–æ—Å–æ—Ñ–∏–∏ CH. –¢—É—Ç –Ω–µ ¬´–æ–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞¬ª, –∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø–æ–¥ –∑–∞–¥–∞—á—É.\
ClickHouse ‚Äî —ç—Ç–æ:\
	* append-only\
	* immutable parts\
	* async merge

–ü–æ—ç—Ç–æ–º—É:\
	* –Ω–µ—Ç UPDATE / DELETE\
	* –≤—Å—ë —Ä–µ—à–∞–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –¥–≤–∏–∂–∫–∞\
	* –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä ENGINE = 50% —É—Å–ø–µ—Ö–∞
	
–ë–∞–∑–æ–≤–∞—è —Å–µ–º—å—è: MergeTree (99% –ø—Ä–æ–¥–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü)

	1. MergeTree - –ë–∞–∑–∞ –≤—Å–µ–≥–æ

–ß—Ç–æ —É–º–µ–µ—Ç\
	* –ö–æ–ª–æ–Ω—á–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ\
	* –ü–∞—Ä—Ç–∏—Ü–∏–∏ (PARTITION BY)\
	* –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ (ORDER BY) ‚Äî –∫–ª—é—á–µ–≤–∞—è –≤–µ—â—å\
	* –ò–Ω–¥–µ–∫—Å—ã (primary key = sparse index)\
	* –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ merge‚Äô—ã

–ö–æ–≥–¥–∞\
	* append-only —Ñ–∞–∫—Ç—ã\
	* –ª–æ–≥–∏\
	* —Å–æ–±—ã—Ç–∏—è\
	* –≤–∏—Ç—Ä–∏–Ω—ã BI

ENGINE = MergeTree\
PARTITION BY toYYYYMM(dt)\
ORDER BY (user_id, dt)


	2. ReplacingMergeTree - ‚Äú–ü—Å–µ–≤–¥–æ-upsert‚Äù, –ø—Ä–∏ merge –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é —Å—Ç—Ä–æ–∫–∏

–¢–∏–ø–æ–≤–æ–π –∫–µ–π—Å\
	* snapshots\
	* SCD1\
	* –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è

ENGINE = ReplacingMergeTree(version)

‚ö†Ô∏è –í–∞–∂–Ω–æ:\
	* —Ñ–∏–∑–∏—á–µ—Å–∫–∏ —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ –µ—Å—Ç—å, –ø–æ–∫–∞ –Ω–µ —Å–º–µ—Ä–∂–∏–ª–∏—Å—å\
	* –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –Ω—É–∂–µ–Ω: SELECT ... FINAL

	3. SummingMergeTree - –ê–≤—Ç–æ-–∞–≥—Ä–µ–≥–∞—Ü–∏—è

–ü—Ä–∏ merge:\
	* —Å—Ç—Ä–æ–∫–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –∫–ª—é—á–æ–º\
	* —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è —Å—É–º–º–∏—Ä—É—é—Ç—Å—è

–ö–æ–≥–¥–∞\
	* pre-aggregated fact tables\
	* —Å—á–µ—Ç—á–∏–∫–∏\
	* –º–µ—Ç—Ä–∏–∫–∏

ENGINE = SummingMergeTree\
ORDER BY (dt, product_id)

‚ö†Ô∏è –û–ø–∞—Å–Ω–æ –¥–ª—è —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏ ‚Äî –Ω–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ merge

	4. AggregatingMergeTree - —Ö–∞—Ä–¥–∫–æ—Ä-–∞–≥—Ä–µ–≥–∞—Ü–∏–∏

–•—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≥—Ä–µ–≥–∞—Ç–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, –∞ –Ω–µ —á–∏—Å–ª–∞:\
	* sumState\
	* uniqState\
	* quantileState

–ö–æ–≥–¥–∞\
	* OLAP-–∫—É–±—ã\
	* rollup-–≤–∏—Ç—Ä–∏–Ω—ã\
	* near-real-time BI

ENGINE = AggregatingMergeTree\
ORDER BY (dt, key)

–ß—Ç–µ–Ω–∏–µ: SELECT sumMerge(metric) FROM table


	5. CollapsingMergeTree - —Å—Ç—Ä–æ–∫–∏-–∞–Ω—Ç–∏—Å—Ç—Ä–æ–∫–∏

–ï—Å—Ç—å –ø–æ–ª–µ sign:\
	* +1 ‚Äî –≤—Å—Ç–∞–≤–∫–∞\
	* -1 ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ

–ö–æ–≥–¥–∞\
	* —Å–æ–±—ã—Ç–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π\
	* CDC-–ø–æ–¥–æ–±–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

‚ö†Ô∏è –°–ª–æ–∂–Ω—ã–π, —Ä–µ–¥–∫–æ –Ω—É–∂–µ–Ω

	6. VersionedCollapsingMergeTree - —Ç–æ –∂–µ —Å–∞–º–æ–µ, —á—Ç–æ –ø—Ä–µ–¥—ã–¥—É—â–∏–π, –Ω–æ:
		* —Å –≤–µ—Ä—Å–∏–µ–π
		* —Ä–µ—à–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø–æ—Ä—è–¥–∫–∞

‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—á–µ–Ω—å —Ä–µ–¥–∫–æ, –Ω–æ –º–æ—â–Ω—ã–π.

----------------------------------------------

–†–µ–ø–ª–∏–∫–∞—Ü–∏—è –∏ –∫–ª–∞—Å—Ç–µ—Ä

	7. ReplicatedMergeTree

–¢–æ –∂–µ —Å–∞–º–æ–µ, –Ω–æ —Å —Ä–µ–ø–ª–∏–∫–∞–º–∏\
	* —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ ZooKeeper / ClickHouse Keeper\
	* –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å\
	* –æ—Å–Ω–æ–≤–∞ prod-–∫–ª–∞—Å—Ç–µ—Ä–æ–≤

ENGINE = ReplicatedMergeTree(\
  '/clickhouse/tables/{shard}/table',\
  '{replica}'\
)

üëâ –í –ø—Ä–æ–¥–µ –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ Replicated*.


	8. Distributed - —ç—Ç–æ –ù–ï —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –Ω–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã, —ç—Ç–æ:
	* –ø—Ä–æ–∫—Å–∏ –Ω–∞–¥ –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏
	* —Ä–∞—Å—Å—ã–ª–∞–µ—Ç SELECT / INSERT –ø–æ —à–∞—Ä–¥–∞–º

ENGINE = Distributed(cluster, db, local_table)

–¢–∏–ø–æ–≤–æ–π –ø–∞—Ç—Ç–µ—Ä–Ω:\
	* local table  -> ReplicatedMergeTree\
	* global table -> Distributed


‚ö° –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –¥–≤–∏–∂–∫–∏

	9. Memory
	* –≤—Å—ë –≤ RAM
	* –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ = –≤—Å—ë –ø–æ—Ç–µ—Ä—è–ª

–ö–æ–≥–¥–∞\
	* –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã\
	* staging\
	* –¥–∂–æ–∏–Ω—ã –º–∞–ª–µ–Ω—å–∫–∏—Ö —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤

----------------------------------------------

–ö–∞–∫ –≤—ã–±–∏—Ä–∞—Ç—å (—Å–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞):
|–ó–∞–¥–∞—á–∞				|–î–≤–∏–∂–æ–∫						|
|-------------------|---------------------------|
|Append-only —Ñ–∞–∫—Ç—ã	| MergeTree					|
|Snapshots / SCD1	| ReplacingMergeTree		|
|–°—á–µ—Ç—á–∏–∫–∏			| SummingMergeTree			|
|OLAP-–∫—É–±—ã 			| AggregatingMergeTree		|
|CDC / —Å–æ–±—ã—Ç–∏—è 		| Collapsing / Versioned	|
|–ü—Ä–æ–¥-–∫–ª–∞—Å—Ç–µ—Ä		| Replicated*				|
|–ì–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø	| Distributed				|

# DDL
–í ClickHouse –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ –æ–¥–Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞ = –Ω–µ—Å–∫–æ–ª—å–∫–æ DDL.
–í —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–º ClickHouse –µ—Å—Ç—å 2 —É—Ä–æ–≤–Ω—è —Ç–∞–±–ª–∏—Ü:
1. –õ–æ–∫–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ ‚Äî —Ä–µ–∞–ª—å–Ω–æ —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ
2. –ì–ª–æ–±–∞–ª—å–Ω–∞—è (Distributed) ‚Äî –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è SELECT / INSERT

üß± –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ ClickHouse –≤ –ø—Ä–æ–¥–µ:

Shard 1:\
  events_local   ‚Üí ReplicatedMergeTree\
Shard 2:\
  events_local   ‚Üí ReplicatedMergeTree

events ‚Üí Distributed ‚Üí events_local

–ö–∞–∫–∏–µ DDL —Ä–µ–∞–ª—å–Ω–æ –Ω—É–∂–Ω—ã?

1. –õ–æ–∫–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (–Ω–∞ –ö–ê–ñ–î–û–ô –Ω–æ–¥–µ):
	* –≠—Ç–æ storage
	* –î–µ–ª–∞–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ
	* –ú–æ–∂–Ω–æ —á–µ—Ä–µ–∑ ON CLUSTER

CREATE TABLE db.events_local ON CLUSTER my_cluster\
(\
  event_date Date,\
  user_id UInt64,\
  value Float64\
)\
ENGINE = ReplicatedReplacingMergeTree(\
  '/clickhouse/tables/{shard}/events',\
  '{replica}'\
)\
ORDER BY (event_date, user_id);

2. Distributed —Ç–∞–±–ª–∏—Ü–∞ (–æ–±—ã—á–Ω–æ –Ω–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö) - —ç—Ç–æ router:
	* –î–∞–Ω–Ω—ã—Ö –Ω–µ —Ö—Ä–∞–Ω–∏—Ç
	* –î–µ–ª–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ª–æ–≥–∏—á–µ—Å–∫–∏, –Ω–æ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –æ–±—ã—á–Ω–æ —Ç–æ–∂–µ –Ω–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö

	CREATE TABLE db.events ON CLUSTER my_cluster\
	AS db.events_local\
	ENGINE = Distributed(\
	  my_cluster,\
	  db,\
	  events_local,\
	  cityHash64(user_id)\
	);

ON CLUSTER –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑–º–Ω–æ–∂–∞–µ—Ç DDL, –Ω–æ –Ω–µ –æ—Ç–º–µ–Ω—è–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ local / distributed

–ü–æ—á–µ–º—É —Ç–∞–∫ —Å–¥–µ–ª–∞–Ω–æ, –ø–æ—á–µ–º—É –Ω–µ–ª—å–∑—è –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π?\
–ü–æ—Ç–æ–º—É —á—Ç–æ ClickHouse:\
	* –Ω–µ –∑–Ω–∞–µ—Ç –∑–∞—Ä–∞–Ω–µ–µ, –≥–¥–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –ª–µ–∂–∞—Ç –¥–∞–Ω–Ω—ã–µ\
	* —Ä–∞–∑–¥–µ–ª—è–µ—Ç:\
	* storage\
	* query planning

Distributed = –ø—Ä–æ—Å—Ç–æ view + proxy, –Ω–µ storage.

–ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏:\
‚ùå –°–æ–∑–¥–∞–ª–∏ —Ç–æ–ª—å–∫–æ Distributed ‚Üí —Ç–∞–±–ª–∏—Ü–∞ –µ—Å—Ç—å, –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç\
‚ùå –°–æ–∑–¥–∞–ª–∏ —Ç–æ–ª—å–∫–æ events_local ‚Üí SELECT –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ 1 shard\
‚ùå –î–µ–ª–∞—é—Ç INSERT –≤ events_local ‚Üí –¥–∞–Ω–Ω—ã–µ –Ω–µ —à–∞—Ä–¥–∏—Ä—É—é—Ç—Å—è\
‚ùå –î—É–º–∞—é—Ç, —á—Ç–æ ON CLUSTER = –æ–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ ‚Üí –Ω–µ—Ç, —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ DDL-—à–∞–±–ª–æ–Ω

–ê–Ω–∞–ª–æ–≥–∏—è:
|ClickHouse		| Hadoop					|
|---------------|---------------------------|
|events_local	| HDFS block / parquet files|
|Distributed	| Spark SQL table			|
|ON CLUSTER		| Ansible / Terraform		|

–î–ª—è –æ–¥–Ω–æ–π –ª–æ–≥–∏—á–µ—Å–∫–æ–π —Ç–∞–±–ª–∏—Ü—ã –Ω—É–∂–Ω—ã –º–∏–Ω–∏–º—É–º 2 DDL:\
	* *_local ‚Äî –≥–¥–µ –ª–µ–∂–∞—Ç –¥–∞–Ω–Ω—ã–µ\
	* Distributed ‚Äî –∫–∞–∫ –ø–æ –Ω–∏–º —Ö–æ–¥—è—Ç –∑–∞–ø—Ä–æ—Å—ã
