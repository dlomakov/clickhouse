# Руководство по установке кластера ClickHouse
Практическое пошаговое руководство по развертыванию Вашего собственного кластера ClickHouse

# Архитектура
![clickhouse](https://github.com/user-attachments/assets/8d9c3a9c-0ba3-4f3f-afa5-c58df470bb59)

| Роль				| Это кто  			|Основная задача				| Порты				|
|-------------------|-------------------|-------------------------------|-------------------|
|ClickHouse Server	|Любая нода			|SQL, хранение, distributed		|9000 / 8123 / 9009	|
|Coordinator		|Любая нода			|План запроса					| —					|
|Shard				|Логическая сущность|Горизонтальное масштабирование	| —					|
|Replica			|Нода				|Отказоустойчивость				| —					|
|ZooKeeper			|Отдельный сервис	|Координация, метаданные		|2181 / 2888 / 3888	|
|Client				|Внешний			|Отправка запросов				|9000 / 8123		|

# Ссылки
1. Официальная документация\
Install ClickHouse on Debian/Ubuntu\
https://clickhouse.com/docs/install?ysclid=mkzsgud2sc374410174

2. ChatGPT



# Роли и компоненты

В ClickHouse важно сразу выкинуть «hadoop-мышление»: формальных master / worker ролей почти нет. Почти каждая нода — и сервер, и координатор.\
ClickHouse Server (часто называют «master-нода») - на самом деле все ClickHouse-ноды равноправны.

----------------------------------------------
1. ClickHouse Server — это универсальный узел, который одновременно может быть:
	* координатором запроса
	* хранителем данных
	* репликой
	* участником DDL ON CLUSTER
	* участником distributed insert/select


Нет выделенного master-а, любая нода может:\
	* принять запрос от клиента\
	* разослать подзапросы по кластеру\
	* агрегировать результат


Основные функции:\
	* Хранение данных (MergeTree, ReplicatedMergeTree)\
	* Выполнение SQL\
	* Межнодовое взаимодействие\
	* Репликация (через ZooKeeper)\
	* Distributed tables\
	* DDL ON CLUSTER

Порты ClickHouse Server

| Порт	| Назначение													|Протокол	|
|-------|---------------------------------------------------------------|-----------|
|9000	|Native client / server / distributed - основной «рабочий» порт	|TCP		|
|8123	|HTTP API - часто нужен BI / curl / REST						|HTTP		|
|9009	|Interserver (критичен для репликации)							|HTTP		|
|9440	|HTTPS (если включён)											|HTTPS		|


Роль определяется конфигурацией и запросом, а не типом ноды, пример:\
	* ты подключился к ch-master-1\
	* сделал SELECT FROM events_dist\
	* ch-master-1 стал координатором\
	* остальные — исполнителями

----------------------------------------------
2. Client (clickhouse-client, BI, приложение) - это источник запросов, а не часть кластера.
Может быть:
	* clickhouse-client
	* BI (Superset, Metabase, PowerBI)
	* backend-приложение
	* ETL job

Что делает:\
	* Подключается к любой ClickHouse-ноде\
	* Не знает о шардах\
	* Не знает о репликах\
	* Вся логика — внутри ClickHouse

Клиент никогда не общается с ZooKeeper\
Порты клиента:

|Порт|Когда используется|
|----|------------------|
|9000|clickhouse-client |
|8123|HTTP / BI			|
|9440|HTTPS				|

----------------------------------------------

2.3. ZooKeeper (координатор, а не data node) - в кластере нет мастер-ноды, как в GreenPlum / Hadoop, всю координацию выполняет ZooKeeper.
ZooKeeper — это control plane ClickHouse, а не data plane.

Он НЕ:
	* хранит данные таблиц
	* участвует в запросах
	* участвует в агрегациях

Он:
	* хранит метаданные реплик
	* выбирает лидера реплики
	* хранит очередь репликации
	* обеспечивает DDL ON CLUSTER

Что именно хранится в ZooKeeper:
	* /clickhouse/tables/{shard}/{table}
	* информация о репликах
	* log репликации
	* distributed DDL queue

Без ZooKeeper:
	* репликации не существует
	* ON CLUSTER не работает


Порты ZooKeeper
|Порт|Назначение			|
|----|----------------------|
|2181|Клиенты (ClickHouse)	|
|2888|Leader ↔ Follower		|
|3888|Leader election		|

Где он ставится:
	* обычно нечетное кол-во нод: 3 или 5 нод
	* может быть совмещён с ClickHouse (но это инфраструктурный компонент!)
	* может быть отдельным кластером
